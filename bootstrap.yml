---
- hosts: all
  sudo: True
  tasks:
  - name: Set hostname
    command: hostname "{{ hostname }}"
    notify: restart networking
  - name: Save hostname permanently
    command: sed -i 's/.*/{{ hostname }}/' /etc/hostname
    when: ansible_os_family == "Debian"
    command: sed -i 's/\(DHCP_\)\?HOSTNAME=.*/DHCP_HOSTNAME={{ hostname }}/' /etc/sysconfig/network
    when: ansible_os_family == "RedHat"
  - name: Set the hosts file
    lineinfile: dest=/etc/hosts
                regexp='^127.0.1.1'
                line='127.0.1.1   {{ hostname }}'

  - name: Add Ansible's public key to authorized_keys
    authorized_key: user=root
                    key="{{ lookup('file', '/home/ansible-bootstrap/.ssh/id_rsa.pub')  }}"
                    path='/etc/skel/.ssh/authorized_keys'
                    manage_dir=no
  - name: Add Spenser's public key to authorized_keys
    authorized_key: user=root
                    key="{{ lookup('file', '/home/ansible-bootstrap/.ssh/spenser.pub')  }}"
                    path='/etc/skel/.ssh/authorized_keys'
                    manage_dir=no
  - name: Create the user account
    user: name={{ username }} password={{ password }} shell=/bin/bash
  - name: Create Spenser's account
    user: name=spenser append=yes shell=/bin/bash
  - name: Setup Spenser as a Sudoer
    lineinfile: dest=/etc/sudoers
                regexp='/^spenser\s/'
                line='spenser ALL=(ALL) NOPASSWD:ALL'
  handlers:
  - name: restart networking
    service: name=networking state=restarted
    when: ansible_os_family == "Debian"
    service: name=network state=restarted
    when: ansible_os_family == "RedHat"
